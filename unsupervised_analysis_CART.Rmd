---
title: Analysis of MC38-HER2 CAR-T cells, with or without IL10 treatment 
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.Il10_CART.html'))})
#output: html_notebook
---

```{r}
renv::restore()

library(remotes)
library(Seurat)
library(ggplot2)
#remotes::install_github("carmonalab/UCell")
#remotes::install_github("carmonalab/scGate")
#remotes::install_github("ncborcherding/escape@dev")

library(escape)
library(viridis)
```

Set up directories
```{r}
#NB: set to your data directory
ddir <- "~/Dropbox/CSI/Collaborations/LiTang"
  
#make plots directory
dir.create(file.path("plots"), showWarnings = FALSE)
```

```{r}
data.seurat <- Read10X(sprintf("%s/data/HER2_CAR_T", ddir))

#These are multiplexed data. Separate samples by their tag
names(data.seurat)
gex <- CreateSeuratObject(data.seurat[["Gene Expression"]], project="IL10_CART", min.cells = 3, min.features = 100)
gex 

valid.hashtags <- c("CMO309","CMO310")
valid.cells <- colnames(gex)
mpc <- data.seurat[["Multiplexing Capture"]][valid.hashtags,valid.cells]

gex[["hash"]] <- CreateAssayObject(counts = mpc)

gex <- NormalizeData(gex, assay = "hash", normalization.method = "CLR")

gex <- HTODemux(gex, assay = "hash", positive.quantile = 0.99)
```

Visualize demux results
```{r}
table(gex$hash.ID)
Idents(gex) <- "hash.ID"
RidgePlot(gex, assay = "hash", features = rownames(gex[["hash"]])[1:2], ncol = 2)
```

See demux assignments by CellRanger. Read these assignments from the provided metadata (multi folder)
```{r}
demux.CR <- read.csv(sprintf("%s/multi/multiplexing_analysis/tag_calls_per_cell.csv",ddir), header=T)
rownames(demux.CR) <- demux.CR$cell_barcode

cells.use <- intersect(colnames(gex), demux.CR$cell_barcode)

gex@meta.data[cells.use,"sample.CR"] <- demux.CR[cells.use, "feature_call"]

table(gex$sample.CR, gex$hash.ID, useNA = "ifany")
gex
```


Visualize demux results
```{r}
RidgePlot(gex, assay = "hash", features = rownames(gex[["hash"]])[1:2], ncol = 2)
```

Compare demuxing done above from scratch (using both hashtags) to demux by CellRanger
```{r}
FeatureScatter(gex, feature1 = "hash_CMO309", feature2 = "hash_CMO310", group.by = "sample.CR") + ggtitle("By cellranger demux")
FeatureScatter(gex, feature1 = "hash_CMO309", feature2 = "hash_CMO310", group.by = "hash.ID") + ggtitle("By percentiles")
```
Why does the Cellranger demux only rely on one hashtag? 

#which annotation to use
```{r}
use.cellranger <- F

if (use.cellranger) {
   gex$Sample <- gex$sample.CR
} else {
  gex$Sample <- gex$hash.ID
}

Idents(gex) <- "Sample"
```


Ribosomal and mitochondrial content
```{r}
data.seurat <- gex
data.seurat <- AddMetaData(data.seurat, metadata = PercentageFeatureSet(data.seurat, pattern = "^Rp[ls]"), col.name = "percent.ribo")
data.seurat <- AddMetaData(data.seurat, metadata = PercentageFeatureSet(data.seurat, pattern = "^mt-"), col.name = "percent.mito")
```


```{r}
Idents(data.seurat) <- "Sample"
VlnPlot(data.seurat, features = c("nFeature_RNA", "nCount_RNA","percent.ribo","percent.mito"), ncol = 2, pt.size=0)
```

Filter out outliers & low quality cells
```{r}
cutoffs <- list()
cutoffs[["percent.ribo"]] <- c(min=max(quantile(data.seurat$percent.ribo,probs=c(0.01)),0),max=min(quantile(data.seurat$percent.ribo,probs=c(0.99)),60))

cutoffs[["percent.mito"]] <- c(min=max(quantile(data.seurat$percent.mito,probs=c(0.01)),0),max=min(quantile(data.seurat$percent.mito,probs=c(0.99)),7.5))

cutoffs[["nFeature_RNA"]] <- c(min=max(quantile(data.seurat$nFeature_RNA,probs=c(0.01)),500),max=min(quantile(data.seurat$nFeature_RNA,probs=c(0.99)),7000))
cutoffs[["nCount_RNA"]] <- c(min=max(quantile(data.seurat$nCount_RNA,probs=c(0.01)),500),max=min(quantile(data.seurat$nCount_RNA,probs=c(0.99)),50000))

print(cutoffs)

dim(data.seurat)

data.seurat <- subset(data.seurat, subset = nFeature_RNA > cutoffs[["nFeature_RNA"]]["min"] & nFeature_RNA < cutoffs[["nFeature_RNA"]]["max"] & 
                       nCount_RNA > cutoffs[["nCount_RNA"]]["min"] & nCount_RNA < cutoffs[["nCount_RNA"]]["max"] &
                       percent.ribo > cutoffs[["percent.ribo"]]["min"] &  percent.ribo < cutoffs[["percent.ribo"]]["max"] &
                    percent.mito > cutoffs[["percent.mito"]]["min"] & percent.mito < cutoffs[["percent.mito"]]["max"] )
dim(data.seurat)

Idents(data.seurat) <- "Sample"
VlnPlot(data.seurat, features = c("nFeature_RNA", "nCount_RNA","percent.ribo","percent.mito"), ncol = 2, pt.size=0)
```
Subset on singlet annotations. Cell labeling (and consequently demultiplexing) was suboptimal, so we lose a considerable amount of cells (negative or doublets)
```{r}
#exclude NA
cells <- colnames(data.seurat)[!is.na(data.seurat$Sample)]

if (length(cells)!=ncol(data.seurat)) {
   data.seurat <- subset(data.seurat, cells = cells)
}
#CMO309 corresponds to HER2_CART,  CMO309 corresponds to HER2_CART_IL10

data.seurat$condition <- as.character(data.seurat$Sample)
data.seurat$condition[data.seurat$Sample == "CMO309"] <- "WT"
data.seurat$condition[data.seurat$Sample == "CMO310"] <- "IL10"

#Remove Negatives and Doublets
data.seurat <- subset(data.seurat, condition %in% c("WT","IL10"))
Idents(data.seurat) <- "condition"
```

Load in list of genes to exclude from dim reduction (ribosomal, mitochondrial, TCR, cell cycle genes) that may distort the space
```{r}
library(scGate)
removeGenes <- unique(unique(unlist(scGate::genes.blacklist.default$Mm)))
length(removeGenes)
```


```{r}
data.seurat <- NormalizeData(data.seurat)
VlnPlot(data.seurat, features = c("Ptprc", "Cd2","Cd8a","Cd4"), ncol = 2, pt.size=0.01)
VlnPlot(data.seurat, features = c("Prf1", "Gzmb","Ifng","Pdcd1"), ncol = 2, pt.size=0.01)

data.seurat <- FindVariableFeatures(data.seurat, selection.method = "vst", nfeatures = 700, verbose = FALSE)
length(data.seurat@assays$RNA@var.features)
data.seurat@assays$RNA@var.features <- data.seurat@assays$RNA@var.features[!data.seurat@assays$RNA@var.features %in% removeGenes]
```


```{r}
set.seed(12345)
ndim=15

data.seurat <- ScaleData(data.seurat, do.scale = TRUE, do.center = TRUE) 
data.seurat <- RunPCA(object = data.seurat, features = data.seurat@assays$RNA@var.features, ndims.print = 1:5, nfeatures.print = 10, npcs = ndim)
data.seurat <- RunUMAP(data.seurat, reduction = "pca", dims = 1:ndim, seed.use=123)
```

```{r}
DimPlot(data.seurat, reduction = "umap", group.by = "condition") + ggtitle("UMAP by study")
```

Note cluster of contaminants. Probably myeloid cells (Spi1, Tyrobp, Lyz2) 

```{r fig.height=3}
FeaturePlot(data.seurat, features = c("Spi1","Tyrobp","Fcgr3","Msr1"))
FeaturePlot(data.seurat, features = c("Ptprc","Cd2","Cd3e","Cd3g"))
FeaturePlot(data.seurat, features = c("Cd4","Cd8a","Cd8b1","Foxp3"))
FeaturePlot(data.seurat, features = c("Lyz2","C1qb","Tyrobp","Trdc"))
```
Filter on T cells (remove contaminants)
```{r}
scGateModels <- get_scGateDB()

model.Tcell <- scGateModels$mouse$generic$Tcell
model.Tcell <- rbind(model.Tcell, c("level2","negative","Macrophage","Lyz2;C1qb;C1qc;Tyrobp"))

data.seurat <- scGate(data.seurat, model.Tcell, 
                      additional.signatures = list("G1S"=scGate::genes.blacklist.default$Mm$cellCycle.G1S,
                                                   "G2M"=scGate::genes.blacklist.default$Mm$cellCycle.G2M))
plot_levels(data.seurat)
data.seurat <- subset(data.seurat, subset=is.pure=="Pure")
```

Recalculate embeddings (parameters can be optimized)
```{r}
set.seed(12345)
#ndim=20
ndim=10
nvar=500

palette.samples <- c("#ff7c79","#6596ff")

data.seurat <- FindVariableFeatures(data.seurat, selection.method = "vst", nfeatures = nvar*2, verbose = FALSE)
length(data.seurat@assays$RNA@var.features)
data.seurat@assays$RNA@var.features <- data.seurat@assays$RNA@var.features[!data.seurat@assays$RNA@var.features %in% removeGenes]
data.seurat@assays$RNA@var.features <- head(data.seurat@assays$RNA@var.features, nvar)

data.seurat <- ScaleData(data.seurat, do.scale = TRUE, do.center = TRUE) 
data.seurat <- RunPCA(object = data.seurat, features = data.seurat@assays$RNA@var.features, ndims.print = 1:5, nfeatures.print = 10, npcs = ndim)
data.seurat <- RunUMAP(data.seurat, reduction = "pca", dims = 1:ndim, seed.use=123)

DimPlot(data.seurat, reduction = "umap", group.by = "condition", cols=palette.samples) +  theme(aspect.ratio=1.1) + ggtitle("UMAP by condition")

ggsave("plots/umap_bysample.pdf",height=4, width=6)

#data.seurat <- subset(data.seurat, subset=condition %in% c("WT","IL10"))
```
Check expression of some genes
```{r fig.height=2.5, fig.width=3}
library(patchwork)
palette2 <- c("whitesmoke","firebrick3")
FeaturePlot(data.seurat, features = c("Spi1","Tyrobp","Fcgr3","Msr1"))
FeaturePlot(data.seurat, features = c("Ptprc","Cd2","Cd3e","Cd3g"))
FeaturePlot(data.seurat, features = c("Cd4","Cd8a","Cd8b1","Il10"))
FeaturePlot(data.seurat, features = c("nCount_RNA","nFeature_RNA","percent.ribo","percent.mito"))
```

```{r fig.height=2, fig.width=8}
p <- FeaturePlot(data.seurat, features = c("Tcf7","Il7r","Gzmb","Prf1","Pdcd1","Ifng","Ccr7","Fos","Gzmc","Gzmf","Havcr2","Mki67"), 
                 max.cutoff = 'q99', pt.size = 0.3, combine=F)

p <- FeaturePlot(data.seurat, features = c("Tcf7","Il7r","Xcl1","Slamf6","Cd200","Lef1","Ccr7","Crtam","Pdcd1","Gzmf","Havcr2","Mki67"), 
                 max.cutoff = 'q99', pt.size = 0.3, combine=F)


for (i in seq_along(p)) {
     p[[i]] <- p[[i]] + theme(aspect.ratio=1.1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank()) +
       scale_color_viridis(discrete = FALSE, option="C")
}
wrap_plots(p, ncol=6)
ggsave("plots/umap_key_genes.pdf",height=5, width=15)

```
Get signatures from mSigDB
```{r}
library(escape)

gene.sets.h <- getGeneSets(species="Mus musculus", library="H")
#names(gene.sets)

gsea.oxphos <- list("HALLMARK_OXIDATIVE_PHOSPHORYLATION" = gene.sets.h[["HALLMARK_OXIDATIVE_PHOSPHORYLATION"]]@geneIds)

gene.sets.c2 <- getGeneSets(species="Mus musculus", library="C2", 
                            gene.sets=c("KEGG_OXIDATIVE_PHOSPHORYLATION","MOOTHA_MITOCHONDRIA","BIOCARTA_ETC_PATHWAY",
                                        "KEGG_PYRUVATE_METABOLISM","REACTOME_MITOCHONDRIAL_BIOGENESIS",
                                        "KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY","BIOCARTA_CTL_PATHWAY",
                                        "WP_TCELL_ANTIGEN_RECEPTOR_TCR_SIGNALING_PATHWAY","PID_TCR_PATHWAY"))

gsea.c2 <- lapply(gene.sets.c2, function(x){x@geneIds})
names(gsea.c2) <- names(gene.sets.c2)

gene.sets.c5 <- getGeneSets(species="Mus musculus", library="C5", 
                            gene.sets=c("GOCC_RESPIRASOME"))
gsea.c5 <- lapply(gene.sets.c5, function(x){x@geneIds})
names(gsea.c5) <- names(gene.sets.c5)


```

Evaluate multi-gene signatures
```{r fig.height=3, fig.width=6}
signatures <- list("Cytotoxic"=c("Prf1","Gzma","Gzmb","Gzmc","Gzmf"), 
                   "Stemness"=c("Tcf7","Ccr7","Sell","Lef1","Il7r"),
                   "Exhaustion"=c("Pdcd1","Lag3","Havcr2","Entpd1","Ctla4"),
                   "TCR_signaling"=c("Cd69","Cd28","Nr4a1","Nr4a2","Nr4a3","Nfkb1","Nfkbia","Nfkbib"),
                   "Cycling"=c(scGate::genes.blacklist.default$Mm$cellCycle.G1S, scGate::genes.blacklist.default$Mm$cellCycle.G2M))


#Using signatures from Carmona et al. Oncoimmunology et al.
#signatures <- list("Cytotoxic"=c("Prf1","Gzmb","Fasl"), 
#                   "Stemness"=c("Tcf7","Sell","Lef1","Il7r"),
#                   "Exhaustion"=c("Pdcd1","Lag3","Havcr2","Tigit","Ctla4"),
#                   "TCR_signaling"=c("Cd69","Cd28","Nr4a1","Nr4a2","Nr4a3","Nfkb1","Nfkbia","Nfkbib"),
#                   "Cycling"=c(scGate::genes.blacklist.default$Mm$cellCycle.G1S, scGate::genes.blacklist.default$Mm$cellCycle.G2M))


signatures <- c(signatures, gsea.oxphos, gsea.c2, gsea.c5)
#signatures <- lapply(signatures, function(x){x[x %in% rownames(data.seurat)]})

data.seurat <- AddModuleScore_UCell(data.seurat, features = signatures)
signames <- paste0(names(signatures), "_UCell") 


#p <- FeaturePlot(data.seurat, features = c("Stemness_UCell","Cytotoxic_UCell","Exhaustion_UCell","Oxphos_UCell","Cycling_UCell"), 
#                 cols=palette2, max.cutoff = 'q99', pt.size = 0.3, combine=F)

p <- FeaturePlot(data.seurat, features = signames, 
                 max.cutoff = 'q99', pt.size = 0.5, combine=F)
       

for (i in seq_along(p)) {
     p[[i]] <- p[[i]] + theme(aspect.ratio=1.1,
        axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size=6)) +
       scale_color_viridis(discrete = FALSE, option="C")
}
wrap_plots(p, ncol=4)
ggsave("plots/umap_signatures.pdf",height=10, width=15)

#Selection
names(p) <- names(signatures)
which.sign <- c("Cytotoxic","Exhaustion","Cycling","TCR_signaling","HALLMARK_OXIDATIVE_PHOSPHORYLATION","KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY")

pp <- p[which.sign]
wrap_plots(pp, ncol=6)
ggsave("plots/umap_signatures.select.pdf",height=4, width=16)

```

Split plots
```{r fig.width=9, fig.height=2.5}
d1 <- subset(data.seurat, subset=condition == "WT")
p1 <- FeaturePlot(d1, features = paste0(which.sign,"_UCell"), cols=palette2, max.cutoff = 'q99',
                   pt.size = 0.5, combine = F)

d2 <- subset(data.seurat, subset=condition == "IL10")
p2 <- FeaturePlot(d2, features = paste0(which.sign,"_UCell"), cols=palette2, max.cutoff = 'q99',
                   pt.size = 0.5, combine = F)

p <- c(p1, p2)

for (i in seq_along(p)) {
     p[[i]] <- p[[i]] + theme(aspect.ratio = 1.1,
        axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size=6)) +
       scale_color_viridis(discrete = FALSE, option="C")
}
wrap_plots(p, ncol=length(p)/2)

ggsave("plots/umap_signatures.splitbysample.pdf",height=6, width=16)

```

```{r}
hist(data.seurat$Cycling_UCell, breaks = 20)
data.seurat$is.cycling <- data.seurat$Cycling_UCell > 0.1
```

Unsupervised clustering
```{r}
kp <- 30
resol <- 0.35
#resol <- 0.6

#kp <- 20
#resol <- 0.3


set.seed(123)
data.seurat <- FindNeighbors(data.seurat, reduction = "pca", dims = 1:ndim, k.param = kp, nn.method = "rann")
#data.seurat <- FindNeighbors(data.seurat, reduction = "pca", dims = 1:ndim)
  
data.seurat  <- FindClusters(data.seurat, resolution = resol)
data.seurat$cluster <- data.seurat@active.ident

library(scales)
nclusters <- length(levels(data.seurat$cluster))
#cpalette <- hue_pal()(nclusters)

cpalette <- c("#ff7c79","#6596ff","#d574fb", "#cacaca")

g <- DimPlot(data.seurat, reduction = "umap", group.by = "cluster", pt.size = 0.5, cols=cpalette, label = T) + 
     NoLegend() + ggtitle("Unsupervised clusters") + theme(aspect.ratio=1.1)

g

ggsave("plots/unsup_clustering_res0.3.pdf", plot=g, height=4, width=6)
```

Frequency of cells by cluster and sample
```{r}
tab <- table(data.seurat$condition, data.seurat$cluster)
tab.norm <- apply(tab, 1, function(x){x/(sum(x))})

to.plot <- reshape2::melt(tab.norm, varname=c("Cluster","Condition"), value.name = "Frequency")
to.plot$Cluster <- as.character(to.plot$Cluster)

ggplot(to.plot, aes(fill=Cluster, y=Frequency, x=Condition)) + 
    geom_bar(position="stack", stat="identity") +
  theme(axis.text.x = element_text(angle = 45)) +
  #scale_fill_manual(values=cpalette) +
    ggtitle("Cluster distribution by treatment") + theme_bw() + coord_flip()

ggsave("plots/unsup_cluster_frequency.flip.pdf", height = 2, width=5)

ggplot(to.plot, aes(fill=Cluster, y=Frequency, x=Condition)) + 
    geom_bar(position="stack", stat="identity") +
  theme(axis.text.x = element_text(angle = 45)) +
  scale_fill_manual(values=cpalette) + theme_bw()

ggsave("plots/unsup_cluster_frequency.pdf", height = 5, width=3)


```

Supervised classification with ProjecTILs
```{r}
library(ProjecTILs)
ref <- load.reference.map()

data.seurat.list <- SplitObject(data.seurat,split.by="condition")

data.projected.list <- make.projection(data.seurat.list, ref=ref, filter.cells = F, ncores = 2)


pll <- list()
pcomp <- list()
for (i in seq_along(data.projected.list)) {
    s <- names(data.projected.list)[i]
    data.projected.list[[s]] <- cellstate.predict(ref = ref, query = data.projected.list[[s]])
    pll[[i]] <- plot.projection(ref, data.projected.list[[s]], pointsize = 0.3, linesize = 0.3) + theme_bw() + theme(aspect.ratio = 0.8) + NoLegend() + ggtitle(s)
    pcomp[[i]] <- plot.statepred.composition(ref, data.projected.list[[s]],metric = "Percent")

}
wrap_plots(pll)


```
```{r}
wrap_plots(pcomp)
```

```{r}
data.projected <- ProjecTILs:::merge.Seurat.embeddings(data.projected.list[[1]],data.projected.list[[2]])
data.seurat$functional.cluster <- data.projected$functional.cluster
refCols <- c("#edbe2a", "#A58AFF", "#53B400", "#F8766D", "#00B6EB", "#d1cfcc", "#FF0000", "#87f6a5", "#e812dd")
names(refCols) <- c("CD8_Tex", "CD8_Tpex", "CD8_EffectorMemory",  "CD8_EarlyActiv", "CD8_NaiveLike", "CD4_NaiveLike", "Tfh", "Th1", "Treg")


DimPlot(data.seurat, reduction = "umap", group.by = "functional.cluster", pt.size = 0.5, label = F, cols = refCols) + 
      ggtitle("Unsupervised clusters") + theme(aspect.ratio=1.1) 

DimPlot(data.seurat, reduction = "umap", group.by = "functional.cluster", pt.size = 0.5, label = F, cols = refCols, split.by = "condition") + 
      ggtitle("Unsupervised clusters") + theme(aspect.ratio=1.1) 

```


Export object
```{r}
saveRDS(data.seurat, file="HER2_CART_seurat.rds")
```




Find markers
```{r}
library(dplyr)
Idents(data.seurat) <- "cluster"

set.seed(1234)

cluster.markers <- FindAllMarkers(data.seurat, only.pos = T, min.pct = 0.1, min.diff.pct=0.1, 
                                  logfc.threshold = 0.25, max.cells.per.ident = 500, test.use="wilcox",base=exp(1))

all <- cluster.markers %>% group_by(cluster) %>% top_n(n = 50, wt = abs(avg_logFC))

for (i in levels(data.seurat@active.ident)) {
    print(subset(all, cluster==i))
}  

```



```{r fig.height=5}
library(EnhancedVolcano)
Idents(data.seurat) <- "cluster"
markers <- FindMarkers(data.seurat, min.pct = 0.1, min.diff.pct=0.05, ident.1 = "1", ident.2 = "0",
                                  logfc.threshold = 0.05, max.cells.per.ident = 500, test.use="wilcox",base=exp(1))

EnhancedVolcano(markers, lab = rownames(markers), x = 'avg_logFC', y = 'p_val', FCcutoff=0.5, pCutoff = 10^(-5), title="Diff. expressed genes", subtitle = "Cluster 0 vs. cluster 1", drawConnectors = T)

ggsave("plots/volcano_cluster0_vs_1.pdf", height=8, width=10)
```



Distributions of expression
```{r fig.height=3, fig.width=6}
data.sub <- subset(data.seurat, subset=cluster %in% c("0","1"))
data.sub$cluster <- as.character(data.sub$cluster)
#ds <- min(table(data.sub$cluster)[1:2])
#data.sub <- subset(data.sub, downsample=ds)


table(data.sub$cluster)

#feats <- c("Prf1","Havcr2","Gzmb","Gzmc","Lag3","Ifng","Cd69","Nr4a1","Ccl4","Ccl5","Bhlhe40","Nr4a1","Nr4a2","Entpd1","Junb") 

feats1 <- c("Pdcd1","Havcr2","Gzmb","Gzmc","Prf1","Gzmf","Jun","Fos","Ifng","Mki67","Il7r")
feats2 <- c("Aldh2","Gdf15","Akr1b8","Ndufv1","Sdhb","Sdhc","Cox5a","Cox15","Atp6v0a2","Hilpda") 

p1 <- VlnPlot(data.sub, features = feats1, group.by = "cluster", pt.size = 0, flip = T, fill.by = "ident", cols = palette.samples, stack = T) + NoLegend()
p2 <- VlnPlot(data.sub, features = feats2, group.by = "cluster", pt.size = 0, flip = T, fill.by = "ident", cols = palette.samples, stack = T) + NoLegend()

p1 | p2


ggsave("plots/vlnplots_bycluster_stacked.pdf", height=9, width=5)


feats <- c(feats1, feats2)
vs <- VlnPlot(data.sub, features = feats, group.by = "cluster", pt.size = 0, cols = palette.samples, combine=F)

for (i in seq_along(vs)) {
   vs[[i]] <- vs[[i]] + geom_boxplot(width = 0.2, outlier.shape = NA) + NoLegend() + 
     theme(axis.title=element_blank() )
}
p <- wrap_plots(vs, ncol = 6)
p


ggsave("plots/vlnplots_bycluster.pdf", height=7, width=11)

```

```{r}
d1 <- DotPlot(data.sub,features = feats1, scale=F) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + NoLegend()
d2 <- DotPlot(data.sub,features = feats2, scale=F) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

d1 / d2

```

By signature
```{r fig.height=5, fig.width=5}
#signatures are defined above
feats <- paste0(names(signatures), "_UCell") 

vs <- VlnPlot(data.sub, features = feats, group.by = "cluster", pt.size = 0, cols = palette.samples,combine = F)

for (i in seq_along(vs)) {
   vs[[i]] <- vs[[i]] + geom_boxplot(width = 0.2, outlier.shape = NA) + NoLegend() + 
     theme(plot.title = element_text(size=6), axis.title.x=element_blank() )
}
p <- wrap_plots(vs, ncol = 5)
p

ggsave("plots/vlnplots_signature_bycluster.pdf", height=7, width=10)
```

More visualization options
```{r}
library(dittoSeq)
sigs <- paste0(names(signatures), "_UCell")
dittoHeatmap(data.sub, genes = NULL, metas = sigs,
             heatmap.colors = viridis(50),
             annot.by = c("condition", "cluster"),
             cluster_cols = TRUE,
             fontsize = 7)

```
```{r}
dittoScatterHex(data.sub, 
    x.var = "HALLMARK_OXIDATIVE_PHOSPHORYLATION_UCell", y.var = "KEGG_OXIDATIVE_PHOSPHORYLATION_UCell", do.contour = TRUE) +             
    theme_classic() +
    scale_fill_gradientn(colors = rev(viridis(10))) 

ggsave("plots/scatterhex.oxphos.pdf", height=5, width=6)

dittoScatterHex(data.sub, 
    x.var = "HALLMARK_OXIDATIVE_PHOSPHORYLATION_UCell", y.var = "MOOTHA_MITOCHONDRIA_UCell", do.contour = TRUE) +             
    theme_classic() +
    scale_fill_gradientn(colors = rev(viridis(10))) 

ggsave("plots/scatterhex.oxphos.vs.mito.pdf", height=5, width=6)

dittoScatterHex(data.sub, 
    x.var = "HALLMARK_OXIDATIVE_PHOSPHORYLATION_UCell", y.var = "Cytotoxic_UCell", 
    do.contour = TRUE, split.by = "cluster") +             
    theme_classic() + ggtitle("Signatures by cluster") +
    scale_fill_gradientn(colors = rev(viridis(10))) 

ggsave("plots/scatterhex.oxphos.vs.cytotoxic_split.pdf", height=5, width=10)

dittoScatterHex(data.sub, 
    y.var = "HALLMARK_OXIDATIVE_PHOSPHORYLATION_UCell", x.var = "REACTOME_MITOCHONDRIAL_BIOGENESIS_UCell", 
    do.contour = TRUE, split.by = "cluster") +             
    theme_classic() + ggtitle("Signatures by cluster") +
    scale_fill_gradientn(colors = rev(viridis(10))) 

ggsave("plots/scatterhex.oxphos.vs.mito_split.pdf", height=5, width=10)

```

```{r}
d0 <- subset(data.sub, subset=cluster == "0")
bulk0 <- apply(d0@assays$RNA@data, 1, mean)

d1 <- subset(data.sub, subset=cluster == "1")
bulk1 <- apply(d1@assays$RNA@data, 1, mean)

epsilon <- 0.1
foldchange <- log2((bulk1 + epsilon)/(bulk0 + epsilon))

foldchange <- sort(foldchange, decreasing = T)

head(sort(foldchange, decreasing = T))
head(sort(foldchange, decreasing = F))
```

Signatures in molten DF
```{r}
df <- reshape2::melt(signatures)
colnames(df) <- c("gene","term")
term2gene <- df[,c("term","gene")]
```

```{r}
library(clusterProfiler)
library(enrichplot)

palette <- c("#999999", "#E69F00", "#56B4E9","#30d6a3","#9b50ed")

do.gsea <- GSEA(foldchange, TERM2GENE = term2gene, exponent=1, pvalueCutoff = 1,verbose = T,minGSSize = 3, maxGSSize = 5000)
do.gsea@result$ID

ids <- which(do.gsea@result$ID %in% c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","KEGG_OXIDATIVE_PHOSPHORYLATION","KEGG_PYRUVATE_METABOLISM"))
gseaplot2(do.gsea, geneSetID = ids,  subplots = c(1:2), pvalue_table = F, color = palette[1:length(ids)])
ggsave("plots/gsea.oxphos.pdf", height=6, width=8)

ids <- which(do.gsea@result$ID %in% c("MOOTHA_MITOCHONDRIA","GOCC_RESPIRASOME","REACTOME_MITOCHONDRIAL_BIOGENESIS","BIOCARTA_ETC_PATHWAY"))
gseaplot2(do.gsea, geneSetID = ids,  subplots = c(1:2), pvalue_table = F, color = palette[1:length(ids)])
ggsave("plots/gsea.mito.pdf", height=6, width=8)

ids <- which(do.gsea@result$ID %in% c("Cytotoxic","Exhaustion","Stemness","Cycling","TCR_signaling"))
gseaplot2(do.gsea, geneSetID = ids,  subplots = c(1:2), pvalue_table = F, color = palette[1:length(ids)])
ggsave("plots/gsea.curated.pdf", height=6, width=8)

p_value <- do.gsea@result$pvalue
p_adj <- do.gsea@result$p.adjust
ES <- do.gsea@result$enrichmentScore
NES <- do.gsea@result$NES
q_value <- do.gsea@result$qvalues
  
pp <- rbind(p_value,p_adj,ES,NES,q_value)
colnames(pp) <- do.gsea@result$ID

t(pp)
write.csv(x=t(pp), file = "gsea_stats.csv")
```

